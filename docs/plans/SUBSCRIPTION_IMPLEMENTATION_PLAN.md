# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –§–∞–∑—ã 2: –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ–µ –≤—Ä–µ–º—è:** 8-13 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π

---

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:
- **–û–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ $29/–º–µ—Å—è—Ü**
- **–¢—Ä–∏–∞–ª –Ω–∞ 3 –¥–Ω—è** –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ–¥–ø–∏—Å–∫–∏ (–∞–∫—Ç–∏–≤–∞—Ü–∏—è, –æ—Ç–º–µ–Ω–∞, –∏—Å—Ç–µ—á–µ–Ω–∏–µ)

---

## üéØ –¶–µ–ª–∏

1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
3. –°–æ–∑–¥–∞—Ç—å API endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç—Ä–∏–∞–ª–æ–≤/–ø–æ–¥–ø–∏—Å–æ–∫
6. –°–æ–∑–¥–∞—Ç—å Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
7. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
- –°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (JWT, User –º–æ–¥–µ–ª—å)
- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- API endpoints –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

### ‚ùå –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:
- –ú–æ–¥–µ–ª—å Subscription
- SubscriptionService
- API endpoints –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
- Celery –∑–∞–¥–∞—á–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞ –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥

---

## üèóÔ∏è –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠–¢–ê–ü 1: Backend ‚Äî –ú–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (1-2 –¥–Ω—è)

#### 1.1. –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ Subscription

**–§–∞–π–ª:** `backend/app/models/subscription.py`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏:**

```python
from enum import Enum
from sqlalchemy import Column, String, DateTime, Numeric, ForeignKey, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from datetime import datetime, timedelta, timezone
from decimal import Decimal
from uuid import uuid4

from app.models.base import BaseModel


class SubscriptionStatus(str, Enum):
    TRIAL = "trial"
    ACTIVE = "active"
    CANCELLED = "cancelled"
    EXPIRED = "expired"


class Subscription(BaseModel):
    __tablename__ = "subscriptions"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False, unique=True, index=True)
    
    # –°—Ç–∞—Ç—É—Å –∏ –ø–ª–∞–Ω
    status = Column(String(20), nullable=False, default=SubscriptionStatus.TRIAL.value, index=True)
    plan_type = Column(String(20), nullable=False, default="monthly")
    price = Column(Numeric(10, 2), nullable=False, default=Decimal("29.00"))
    currency = Column(String(3), nullable=False, default="USD")
    
    # –î–∞—Ç—ã —Ç—Ä–∏–∞–ª–∞
    trial_started_at = Column(DateTime(timezone=True), nullable=True)
    trial_ends_at = Column(DateTime(timezone=True), nullable=True, index=True)
    
    # –î–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏
    started_at = Column(DateTime(timezone=True), nullable=True)
    expires_at = Column(DateTime(timezone=True), nullable=True, index=True)
    cancelled_at = Column(DateTime(timezone=True), nullable=True)
    
    # –ü–ª–∞—Ç–µ–∂–∏
    payment_provider = Column(String(50), nullable=True)  # stripe, paypal, etc.
    payment_subscription_id = Column(String(255), nullable=True)  # ID –≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    metadata = Column(JSON, nullable=True, default=dict)
    
    # Relationships
    user = relationship("User", backref="subscription")
    
    __table_args__ = (
        {"comment": "User subscriptions and trials"}
    )
    
    def is_active(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏–ª–∏ —Ç—Ä–∏–∞–ª"""
        if self.status == SubscriptionStatus.EXPIRED:
            return False
        if self.status == SubscriptionStatus.CANCELLED:
            return False
        
        now = datetime.now(timezone.utc)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–∞–ª–∞
        if self.status == SubscriptionStatus.TRIAL:
            if self.trial_ends_at and self.trial_ends_at < now:
                return False
            return True
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
        if self.status == SubscriptionStatus.ACTIVE:
            if self.expires_at and self.expires_at < now:
                return False
            return True
        
        return False
    
    def days_remaining(self) -> int:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞ –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
        if not self.is_active():
            return 0
        
        now = datetime.now(timezone.utc)
        
        if self.status == SubscriptionStatus.TRIAL and self.trial_ends_at:
            delta = self.trial_ends_at - now
            return max(0, delta.days)
        
        if self.status == SubscriptionStatus.ACTIVE and self.expires_at:
            delta = self.expires_at - now
            return max(0, delta.days)
        
        return 0
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/app/models/subscription.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å enum `SubscriptionStatus`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å `Subscription` —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã `is_active()` –∏ `days_remaining()`
- [ ] –î–æ–±–∞–≤–∏—Ç—å relationship –∫ User (one-to-one)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

#### 1.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

**–§–∞–π–ª:** `backend/app/models/user.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
# –î–æ–±–∞–≤–∏—Ç—å relationship (—É–∂–µ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ backref, –Ω–æ –º–æ–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å)
subscription = relationship("Subscription", back_populates="user", uselist=False)

# –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
def has_active_subscription(self) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏–ª–∏ —Ç—Ä–∏–∞–ª"""
    if not self.subscription:
        return False
    return self.subscription.is_active()
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å relationship –∫ Subscription (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —è–≤–Ω—ã–π)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `has_active_subscription()` –≤ –º–æ–¥–µ–ª—å User
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã

#### 1.3. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `backend/alembic/versions/XXXX_add_subscriptions_table.py`

**–ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞:**
- –°–æ–∑–¥–∞—Ç—å enum —Ç–∏–ø `subscriptionstatus` –≤ PostgreSQL
- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `subscriptions` —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã: `user_id`, `status`, `trial_ends_at`, `expires_at`
- –î–æ–±–∞–≤–∏—Ç—å foreign key –Ω–∞ `users.id` —Å CASCADE
- –î–æ–±–∞–≤–∏—Ç—å unique constraint –Ω–∞ `user_id`

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ `alembic revision --autogenerate`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏

---

### –≠–¢–ê–ü 2: Backend ‚Äî –°–µ—Ä–≤–∏—Å –ø–æ–¥–ø–∏—Å–æ–∫ (2-3 –¥–Ω—è)

#### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ SubscriptionService

**–§–∞–π–ª:** `backend/app/services/subscription_service.py`

**–ú–µ—Ç–æ–¥—ã:**

```python
from typing import Optional
from uuid import UUID
from datetime import datetime, timedelta, timezone
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from loguru import logger

from app.models.subscription import Subscription, SubscriptionStatus
from app.models.user import User


class SubscriptionService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ —Ç—Ä–∏–∞–ª–∞–º–∏"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create_trial_subscription(self, user_id: UUID) -> Subscription:
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —Å —Ç—Ä–∏–∞–ª–æ–º –Ω–∞ 3 –¥–Ω—è
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            Subscription –æ–±—ä–µ–∫—Ç —Å —Ç—Ä–∏–∞–ª–æ–º
        """
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ —É–∂–µ –ø–æ–¥–ø–∏—Å–∫–∏
        result = await self.db.execute(
            select(Subscription).where(Subscription.user_id == user_id)
        )
        existing = result.scalar_one_or_none()
        
        if existing:
            logger.warning(f"Subscription already exists for user {user_id}")
            return existing
        
        now = datetime.now(timezone.utc)
        trial_ends_at = now + timedelta(days=3)
        
        subscription = Subscription(
            user_id=user_id,
            status=SubscriptionStatus.TRIAL,
            plan_type="monthly",
            price=Decimal("29.00"),
            currency="USD",
            trial_started_at=now,
            trial_ends_at=trial_ends_at,
            metadata={}
        )
        
        self.db.add(subscription)
        await self.db.commit()
        await self.db.refresh(subscription)
        
        logger.info(f"Created trial subscription for user {user_id}, expires at {trial_ends_at}")
        
        return subscription
    
    async def check_subscription_access(self, user_id: UUID) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏–ª–∏ —Ç—Ä–∏–∞–ª
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞/—Ç—Ä–∏–∞–ª, False –∏–Ω–∞—á–µ
        """
        result = await self.db.execute(
            select(Subscription).where(Subscription.user_id == user_id)
        )
        subscription = result.scalar_one_or_none()
        
        if not subscription:
            return False
        
        return subscription.is_active()
    
    async def activate_subscription(
        self, 
        subscription_id: UUID, 
        payment_data: dict
    ) -> Subscription:
        """
        –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
        
        Args:
            subscription_id: ID –ø–æ–¥–ø–∏—Å–∫–∏
            payment_data: –î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ (provider, payment_subscription_id)
            
        Returns:
            –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Subscription –æ–±—ä–µ–∫—Ç
        """
        result = await self.db.execute(
            select(Subscription).where(Subscription.id == subscription_id)
        )
        subscription = result.scalar_one_or_none()
        
        if not subscription:
            raise ValueError(f"Subscription not found: {subscription_id}")
        
        now = datetime.now(timezone.utc)
        expires_at = now + timedelta(days=30)  # –ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
        
        subscription.status = SubscriptionStatus.ACTIVE
        subscription.started_at = now
        subscription.expires_at = expires_at
        subscription.payment_provider = payment_data.get("provider")
        subscription.payment_subscription_id = payment_data.get("payment_subscription_id")
        
        await self.db.commit()
        await self.db.refresh(subscription)
        
        logger.info(f"Activated subscription {subscription_id} for user {subscription.user_id}")
        
        return subscription
    
    async def cancel_subscription(self, subscription_id: UUID) -> Subscription:
        """
        –û—Ç–º–µ–Ω—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
        
        Args:
            subscription_id: ID –ø–æ–¥–ø–∏—Å–∫–∏
            
        Returns:
            –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Subscription –æ–±—ä–µ–∫—Ç
        """
        result = await self.db.execute(
            select(Subscription).where(Subscription.id == subscription_id)
        )
        subscription = result.scalar_one_or_none()
        
        if not subscription:
            raise ValueError(f"Subscription not found: {subscription_id}")
        
        subscription.status = SubscriptionStatus.CANCELLED
        subscription.cancelled_at = datetime.now(timezone.utc)
        
        await self.db.commit()
        await self.db.refresh(subscription)
        
        logger.info(f"Cancelled subscription {subscription_id} for user {subscription.user_id}")
        
        return subscription
    
    async def get_user_subscription(self, user_id: UUID) -> Optional[Subscription]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            Subscription –æ–±—ä–µ–∫—Ç –∏–ª–∏ None
        """
        result = await self.db.execute(
            select(Subscription).where(Subscription.user_id == user_id)
        )
        return result.scalar_one_or_none()
    
    async def expire_trials(self) -> int:
        """
        –ü–æ–º–µ—á–∞–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ —Ç—Ä–∏–∞–ª—ã –∫–∞–∫ EXPIRED
        
        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
        """
        now = datetime.now(timezone.utc)
        
        result = await self.db.execute(
            select(Subscription).where(
                Subscription.status == SubscriptionStatus.TRIAL,
                Subscription.trial_ends_at < now
            )
        )
        expired_trials = result.scalars().all()
        
        count = 0
        for subscription in expired_trials:
            subscription.status = SubscriptionStatus.EXPIRED
            count += 1
        
        if count > 0:
            await self.db.commit()
            logger.info(f"Expired {count} trial subscriptions")
        
        return count
    
    async def expire_subscriptions(self) -> int:
        """
        –ü–æ–º–µ—á–∞–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∫–∞–∫ EXPIRED
        
        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
        """
        now = datetime.now(timezone.utc)
        
        result = await self.db.execute(
            select(Subscription).where(
                Subscription.status == SubscriptionStatus.ACTIVE,
                Subscription.expires_at < now
            )
        )
        expired_subscriptions = result.scalars().all()
        
        count = 0
        for subscription in expired_subscriptions:
            subscription.status = SubscriptionStatus.EXPIRED
            count += 1
        
        if count > 0:
            await self.db.commit()
            logger.info(f"Expired {count} active subscriptions")
        
        return count
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/app/services/subscription_service.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã

---

### –≠–¢–ê–ü 3: Backend ‚Äî API endpoints (1-2 –¥–Ω—è)

#### 3.1. –°–æ–∑–¥–∞–Ω–∏–µ API endpoints

**–§–∞–π–ª:** `backend/app/api/v1/endpoints/subscriptions.py`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

```python
from fastapi import APIRouter, Depends, HTTPException, Body
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Dict, Any
from uuid import UUID

from app.core.database import get_db
from app.api.dependencies import get_current_user
from app.models import User
from app.services.subscription_service import SubscriptionService

router = APIRouter()


@router.get("/current")
async def get_current_subscription(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        Subscription –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏
    """
    service = SubscriptionService(db)
    subscription = await service.get_user_subscription(current_user.id)
    
    if not subscription:
        return {"subscription": None}
    
    return {
        "subscription": {
            "id": str(subscription.id),
            "status": subscription.status.value,
            "plan_type": subscription.plan_type,
            "price": float(subscription.price),
            "currency": subscription.currency,
            "trial_started_at": subscription.trial_started_at.isoformat() if subscription.trial_started_at else None,
            "trial_ends_at": subscription.trial_ends_at.isoformat() if subscription.trial_ends_at else None,
            "started_at": subscription.started_at.isoformat() if subscription.started_at else None,
            "expires_at": subscription.expires_at.isoformat() if subscription.expires_at else None,
            "days_remaining": subscription.days_remaining(),
            "is_active": subscription.is_active()
        }
    }


@router.post("/create")
async def create_subscription(
    request: Dict[str, Any] = Body(...),
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
    
    Request body:
        - payment_provider: str (stripe, paypal, etc.)
        - payment_subscription_id: str
        - subscription_id: UUID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é)
    
    Returns:
        Subscription –¥–∞–Ω–Ω—ã–µ
    """
    service = SubscriptionService(db)
    
    payment_data = {
        "provider": request.get("payment_provider"),
        "payment_subscription_id": request.get("payment_subscription_id")
    }
    
    subscription_id = request.get("subscription_id")
    
    if subscription_id:
        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
        subscription = await service.activate_subscription(UUID(subscription_id), payment_data)
    else:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É (–µ—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–∏–∞–ª–∞)
        existing = await service.get_user_subscription(current_user.id)
        if existing:
            subscription = await service.activate_subscription(existing.id, payment_data)
        else:
            # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∏–∞–ª, –ø–æ—Ç–æ–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º (–Ω–µ–æ–±—ã—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)
            trial = await service.create_trial_subscription(current_user.id)
            subscription = await service.activate_subscription(trial.id, payment_data)
    
    return {
        "subscription": {
            "id": str(subscription.id),
            "status": subscription.status.value,
            "expires_at": subscription.expires_at.isoformat() if subscription.expires_at else None
        }
    }


@router.post("/cancel")
async def cancel_subscription(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    –û—Ç–º–µ–Ω—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã
    """
    service = SubscriptionService(db)
    subscription = await service.get_user_subscription(current_user.id)
    
    if not subscription:
        raise HTTPException(status_code=404, detail="Subscription not found")
    
    await service.cancel_subscription(subscription.id)
    
    return {"status": "cancelled", "message": "Subscription cancelled successfully"}


@router.get("/check-access")
async def check_subscription_access(
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
    
    Returns:
        has_access: bool
        reason: str (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞)
    """
    service = SubscriptionService(db)
    has_access = await service.check_subscription_access(current_user.id)
    
    if has_access:
        subscription = await service.get_user_subscription(current_user.id)
        days_remaining = subscription.days_remaining() if subscription else 0
        
        return {
            "has_access": True,
            "days_remaining": days_remaining,
            "status": subscription.status.value if subscription else None
        }
    else:
        subscription = await service.get_user_subscription(current_user.id)
        
        if not subscription:
            reason = "No subscription found. Please complete onboarding to start trial."
        elif subscription.status == SubscriptionStatus.EXPIRED:
            reason = "Your trial/subscription has expired. Please subscribe to continue."
        elif subscription.status == SubscriptionStatus.CANCELLED:
            reason = "Your subscription was cancelled. Please subscribe to continue."
        else:
            reason = "Access denied. Please check your subscription status."
        
        return {
            "has_access": False,
            "reason": reason,
            "status": subscription.status.value if subscription else None
        }
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/app/api/v1/endpoints/subscriptions.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ 4 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å router –≤ `backend/app/api/v1/api.py`

---

### –≠–¢–ê–ü 4: Backend ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–æ–º (1 –¥–µ–Ω—å)

#### 4.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ complete_onboarding

**–§–∞–π–ª:** `backend/app/api/v1/endpoints/onboarding.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ `complete_onboarding`:**

```python
# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è UserPreferences –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–π –≤ subscribed_companies
# –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞:

from app.services.subscription_service import SubscriptionService

# –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏: await db.commit() (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è user_prefs)

# 6. Create trial subscription
subscription_service = SubscriptionService(db)
try:
    trial_subscription = await subscription_service.create_trial_subscription(final_user_id)
    logger.info(f"Created trial subscription for user {final_user_id}, expires at {trial_subscription.trial_ends_at}")
except Exception as e:
    # –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–∞–ª - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∂–µ
    logger.warning(f"Failed to create trial subscription for user {final_user_id}: {e}")
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `SubscriptionService`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `create_trial_subscription()` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–∞–ª)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### –≠–¢–ê–ü 5: Backend ‚Äî Celery –∑–∞–¥–∞—á–∏ (1 –¥–µ–Ω—å)

#### 5.1. –°–æ–∑–¥–∞–Ω–∏–µ Celery –∑–∞–¥–∞—á

**–§–∞–π–ª:** `backend/app/tasks/subscriptions.py`

**–ó–∞–¥–∞—á–∏:**

```python
"""
Celery tasks for subscription management
"""

from loguru import logger
from app.celery_app import celery_app
from app.core.celery_async import run_async_task
from app.core.celery_database import CelerySessionLocal
from app.services.subscription_service import SubscriptionService


@celery_app.task(name="subscriptions.check_expired_trials")
def check_expired_trials():
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç—Ä–∏–∞–ª–æ–≤
    
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å —á–µ—Ä–µ–∑ Celery Beat
    """
    async def _check_expired_trials():
        async with CelerySessionLocal() as db:
            service = SubscriptionService(db)
            count = await service.expire_trials()
            return count
    
    try:
        count = run_async_task(_check_expired_trials())
        logger.info(f"Checked expired trials: {count} subscriptions expired")
        return {"expired_count": count}
    except Exception as e:
        logger.error(f"Error checking expired trials: {e}", exc_info=True)
        raise


@celery_app.task(name="subscriptions.check_expired_subscriptions")
def check_expired_subscriptions():
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
    
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å —á–µ—Ä–µ–∑ Celery Beat
    """
    async def _check_expired_subscriptions():
        async with CelerySessionLocal() as db:
            service = SubscriptionService(db)
            count = await service.expire_subscriptions()
            return count
    
    try:
        count = run_async_task(_check_expired_subscriptions())
        logger.info(f"Checked expired subscriptions: {count} subscriptions expired")
        return {"expired_count": count}
    except Exception as e:
        logger.error(f"Error checking expired subscriptions: {e}", exc_info=True)
        raise
```

#### 5.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Celery Beat

**–§–∞–π–ª:** `backend/app/celery_app.py`

**–î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:**

```python
from celery.schedules import crontab

beat_schedule = {
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ ...
    
    'check-expired-trials': {
        'task': 'subscriptions.check_expired_trials',
        'schedule': crontab(minute=0),  # –ö–∞–∂–¥—ã–π —á–∞—Å
    },
    'check-expired-subscriptions': {
        'task': 'subscriptions.check_expired_subscriptions',
        'schedule': crontab(minute=0),  # –ö–∞–∂–¥—ã–π —á–∞—Å
    },
}
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/app/tasks/subscriptions.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ `check_expired_trials` –∏ `check_expired_subscriptions`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ Celery Beat —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á

---

### –≠–¢–ê–ü 6: Frontend ‚Äî –¢–∏–ø—ã –∏ API —Å–µ—Ä–≤–∏—Å (0.5 –¥–Ω—è)

#### 6.1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ TypeScript —Ç–∏–ø–æ–≤

**–§–∞–π–ª:** `frontend/src/types/index.ts`

**–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã:**

```typescript
export enum SubscriptionStatus {
  TRIAL = "trial",
  ACTIVE = "active",
  CANCELLED = "cancelled",
  EXPIRED = "expired"
}

export interface Subscription {
  id: string
  status: SubscriptionStatus
  plan_type: string
  price: number
  currency: string
  trial_started_at?: string
  trial_ends_at?: string
  started_at?: string
  expires_at?: string
  days_remaining: number
  is_active: boolean
}

export interface SubscriptionAccessResponse {
  has_access: boolean
  days_remaining?: number
  reason?: string
  status?: SubscriptionStatus
}
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã –≤ `frontend/src/types/index.ts`
- [ ] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã

#### 6.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API —Å–µ—Ä–≤–∏—Å–∞

**–§–∞–π–ª:** `frontend/src/services/api.ts`

**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã:**

```typescript
// –í –∫–ª–∞—Å—Å ApiService

async getCurrentSubscription(): Promise<{ subscription: Subscription | null }> {
  const response = await this.api.get<{ subscription: Subscription | null }>('/subscriptions/current')
  return response.data
}

async checkSubscriptionAccess(): Promise<SubscriptionAccessResponse> {
  const response = await this.api.get<SubscriptionAccessResponse>('/subscriptions/check-access')
  return response.data
}

async createSubscription(paymentData: {
  payment_provider: string
  payment_subscription_id: string
  subscription_id?: string
}): Promise<{ subscription: Subscription }> {
  const response = await this.api.post<{ subscription: Subscription }>('/subscriptions/create', paymentData)
  return response.data
}

async cancelSubscription(): Promise<{ status: string; message: string }> {
  const response = await this.api.post<{ status: string; message: string }>('/subscriptions/cancel')
  return response.data
}
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≤ `ApiService`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã

---

### –≠–¢–ê–ü 7: Frontend ‚Äî –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (2-3 –¥–Ω—è)

#### 7.1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `frontend/src/components/subscription/SubscriptionStatus.tsx`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:**

```typescript
import { useEffect, useState } from 'react'
import { ApiService } from '@/services/api'
import { Subscription, SubscriptionStatus } from '@/types'
import { Calendar, CreditCard, AlertCircle } from 'lucide-react'
import toast from 'react-hot-toast'

export default function SubscriptionStatusCard() {
  const [subscription, setSubscription] = useState<Subscription | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadSubscription()
  }, [])

  const loadSubscription = async () => {
    try {
      const response = await ApiService.getCurrentSubscription()
      setSubscription(response.subscription)
    } catch (err: any) {
      toast.error(err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  if (loading) {
    return <div className="animate-pulse bg-gray-200 h-24 rounded-lg" />
  }

  if (!subscription) {
    return (
      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div className="flex items-center gap-2 text-yellow-800">
          <AlertCircle className="w-5 h-5" />
          <span className="font-medium">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</span>
        </div>
        <p className="text-sm text-yellow-700 mt-2">
          –ó–∞–≤–µ—Ä—à–∏—Ç–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–∏–∞–ª –Ω–∞ 3 –¥–Ω—è
        </p>
      </div>
    )
  }

  const getStatusColor = () => {
    switch (subscription.status) {
      case SubscriptionStatus.TRIAL:
        return 'bg-blue-50 border-blue-200 text-blue-800'
      case SubscriptionStatus.ACTIVE:
        return 'bg-green-50 border-green-200 text-green-800'
      case SubscriptionStatus.EXPIRED:
        return 'bg-red-50 border-red-200 text-red-800'
      case SubscriptionStatus.CANCELLED:
        return 'bg-gray-50 border-gray-200 text-gray-800'
      default:
        return 'bg-gray-50 border-gray-200 text-gray-800'
    }
  }

  const getStatusText = () => {
    switch (subscription.status) {
      case SubscriptionStatus.TRIAL:
        return '–¢—Ä–∏–∞–ª –∞–∫—Ç–∏–≤–µ–Ω'
      case SubscriptionStatus.ACTIVE:
        return '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞'
      case SubscriptionStatus.EXPIRED:
        return '–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞'
      case SubscriptionStatus.CANCELLED:
        return '–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞'
      default:
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å'
    }
  }

  return (
    <div className={`border rounded-lg p-4 ${getStatusColor()}`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <CreditCard className="w-5 h-5" />
          <span className="font-semibold">{getStatusText()}</span>
        </div>
        {subscription.is_active && (
          <span className="text-sm font-medium">
            ${subscription.price}/{subscription.plan_type === 'monthly' ? '–º–µ—Å' : '–≥–æ–¥'}
          </span>
        )}
      </div>

      {subscription.is_active && subscription.days_remaining > 0 && (
        <div className="flex items-center gap-2 text-sm mt-2">
          <Calendar className="w-4 h-4" />
          <span>
            {subscription.days_remaining === 1
              ? '–û—Å—Ç–∞–ª—Å—è 1 –¥–µ–Ω—å'
              : `–û—Å—Ç–∞–ª–æ—Å—å ${subscription.days_remaining} –¥–Ω–µ–π`}
          </span>
        </div>
      )}

      {subscription.status === SubscriptionStatus.TRIAL && subscription.days_remaining <= 1 && (
        <button
          onClick={() => {
            // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
            toast('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')
          }}
          className="mt-3 w-full bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors font-medium"
        >
          –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        </button>
      )}

      {subscription.status === SubscriptionStatus.EXPIRED && (
        <button
          onClick={() => {
            // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
            toast('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')
          }}
          className="mt-3 w-full bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors font-medium"
        >
          –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        </button>
      )}
    </div>
  )
}
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `frontend/src/components/subscription/SubscriptionStatus.tsx`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª–∏ –∏ –∏–∫–æ–Ω–∫–∏

#### 7.2. –•—É–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞

**–§–∞–π–ª:** `frontend/src/hooks/useSubscriptionAccess.ts`

**–•—É–∫:**

```typescript
import { useState, useEffect } from 'react'
import { ApiService } from '@/services/api'
import { SubscriptionAccessResponse } from '@/types'

export function useSubscriptionAccess() {
  const [hasAccess, setHasAccess] = useState<boolean | null>(null)
  const [reason, setReason] = useState<string | null>(null)
  const [loading, setLoading] = useState(true)
  const [daysRemaining, setDaysRemaining] = useState<number | null>(null)

  useEffect(() => {
    checkAccess()
  }, [])

  const checkAccess = async () => {
    try {
      setLoading(true)
      const response = await ApiService.checkSubscriptionAccess()
      setHasAccess(response.has_access)
      setReason(response.reason || null)
      setDaysRemaining(response.days_remaining || null)
    } catch (err: any) {
      console.error('Error checking subscription access:', err)
      setHasAccess(false)
      setReason('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–∞')
    } finally {
      setLoading(false)
    }
  }

  return {
    hasAccess,
    reason,
    loading,
    daysRemaining,
    refetch: checkAccess
  }
}
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `frontend/src/hooks/useSubscriptionAccess.ts`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ö—É–∫ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `refetch` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

#### 7.3. –ë–∞–Ω–Ω–µ—Ä –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `frontend/src/components/subscription/SubscriptionBanner.tsx`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:**

```typescript
import { useSubscriptionAccess } from '@/hooks/useSubscriptionAccess'
import { AlertCircle, X } from 'lucide-react'
import { useState } from 'react'

export default function SubscriptionBanner() {
  const { hasAccess, reason, loading } = useSubscriptionAccess()
  const [dismissed, setDismissed] = useState(false)

  if (loading || hasAccess || dismissed) {
    return null
  }

  return (
    <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
      <div className="flex items-start">
        <AlertCircle className="w-5 h-5 text-yellow-400 mr-3 flex-shrink-0 mt-0.5" />
        <div className="flex-1">
          <h3 className="text-sm font-medium text-yellow-800">
            –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞
          </h3>
          <p className="text-sm text-yellow-700 mt-1">
            {reason || '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞'}
          </p>
        </div>
        <button
          onClick={() => setDismissed(true)}
          className="ml-4 text-yellow-400 hover:text-yellow-600"
        >
          <X className="w-5 h-5" />
        </button>
      </div>
    </div>
  )
}
```

**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `frontend/src/components/subscription/SubscriptionBanner.tsx`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±–∞–Ω–Ω–µ—Ä–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç—å –±–∞–Ω–Ω–µ—Ä
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

### –≠–¢–ê–ü 8: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 –¥–Ω—è)

#### 8.1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å `SubscriptionStatusCard` –≤ Header –∏–ª–∏ Dashboard
- [ ] –î–æ–±–∞–≤–∏—Ç—å `SubscriptionBanner` –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `useSubscriptionAccess` –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫—É
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ä–æ—É—Ç–∏–Ω–≥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

#### 8.2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ó–∞–¥–∞—á–∏:**
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ (–≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –≤ –ë–î)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Celery –∑–∞–¥–∞—á–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ API endpoints
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Backend:
- [ ] –ú–æ–¥–µ–ª—å Subscription —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] SubscriptionService —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] API –ø–æ–¥–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (4 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞)
- [ ] Celery –∑–∞–¥–∞—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –¢—Ä–∏–∞–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

### Frontend:
- [ ] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞
- [ ] –ë–∞–Ω–Ω–µ—Ä –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –¢–∏–ø—ã TypeScript –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] API —Å–µ—Ä–≤–∏—Å –æ–±–Ω–æ–≤–ª–µ–Ω

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –¢—Ä–∏–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Celery –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

---

## üîÑ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **–≠—Ç–∞–ø 1** (1-2 –¥–Ω—è) - –ú–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
2. **–≠—Ç–∞–ø 2** (2-3 –¥–Ω—è) - SubscriptionService
3. **–≠—Ç–∞–ø 3** (1-2 –¥–Ω—è) - API endpoints
4. **–≠—Ç–∞–ø 4** (1 –¥–µ–Ω—å) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–æ–º
5. **–≠—Ç–∞–ø 5** (1 –¥–µ–Ω—å) - Celery –∑–∞–¥–∞—á–∏
6. **–≠—Ç–∞–ø 6** (0.5 –¥–Ω—è) - Frontend —Ç–∏–ø—ã –∏ API
7. **–≠—Ç–∞–ø 7** (2-3 –¥–Ω—è) - Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
8. **–≠—Ç–∞–ø 8** (1-2 –¥–Ω—è) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–û–±—â–µ–µ –≤—Ä–µ–º—è: 8-13 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π**

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞:** –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–∞–ª –ø—Ä–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ API)

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞:** –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º

3. **–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:** –ü–æ–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ (Stripe, PayPal) –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ - –∫–Ω–æ–ø–∫–∏ "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –±—É–¥—É—Ç –∑–∞–≥–ª—É—à–∫–∞–º–∏

4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Ç—Ä–∏–∞–ª–∞ (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

5. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:** –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏ –∏–º —Ç—Ä–∏–∞–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/ONBOARDING_SUBSCRIPTION_PLAN.md` - –û–±—â–∏–π –ø–ª–∞–Ω –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –∏ –ø–æ–¥–ø–∏—Å–æ–∫
- `docs/ONBOARDING_HOMEPAGE_INTEGRATION_PLAN.md` - –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** ‚úÖ



