# Phase 2 — Raw SQL Inventory

Дата: 2025-11-10  
Подготовил: GPT-5 Codex

---

## 1. Цель
Зафиксировать все места использования “сырого” SQL (строковые запросы, `text()`), оценить риски и определить действия по переводу на SQLAlchemy Core/ORM или оставление как есть (например, в миграциях).

## 2. Итог проверки
| Категория | Файл / Модуль | Контекст | Риск | План |
|-----------|----------------|----------|------|------|
| **Runtime (API/Services)** | _не обнаружено_ | Актуальные эндпоинты (`users.py`, `notifications.py`, `telegram.py`) используют ORM/SQLAlchemy Core. | Низкий | Продолжать мониторить при изменениях. |
| **Скрипты обслуживания** | `backend/scripts/simple_fix_categories.py` | Ад-хок обновление категорий новостей (раньше использовал raw SQL). | Низкий | ✅ Переведён на SQLAlchemy AsyncSession; использует модели домена `NewsItem/Company`. |
|  | `backend/reset_migrations.py` | Очистка таблиц перед сбросом миграций (`DROP TABLE ...`). | Средний | Допустимо (админ-скрипт), при переносе в CLI можно использовать SQLAlchemy MetaData. |
|  | `backend/scripts/check_database.py` | Проверка готовности БД (`SELECT 1`). | Низкий | Оставить (это health-check). |
| **Alembic миграции** | `alembic/versions/*.py` (`op.execute(...)`) | Создание/обновление enum типов, backfill данных. | Ожидаемо | Оставить: миграции допускают прямой SQL. |
| **Документация / SQL snippets** | `docs/*.md`, `scripts/*.sql` | Инструкции для ручного вмешательства. | Н/Д | Не требуют автоматизации. |

### Автоматические проверки
- `backend/scripts/check_no_raw_sql.py` — сканирует `app/` на предмет прямых SQL-строк в `execute()`/`text()` (добавлен в CI после миграций; см. `.github/workflows/ci.yml`).  
- Исключения для намеренного SQL можно добавлять в `ALLOWED_PATHS` внутри скрипта.

## 3. Проверенные модули (без сырых запросов)
- `backend/app/api/v1/endpoints/users.py` — обновления digest/preferences переведены на ORM.
- `backend/app/api/v1/endpoints/notifications.py` — обновления настроек через ORM.
- `backend/app/api/v1/endpoints/telegram.py` — использует ORM/SQLAlchemy Core.
- `backend/app/services/*.py` — запросы построены через `select`, `update`, `delete` из SQLAlchemy.

## 4. Рекомендации
1. **Документы B-202:** обновить backlog — основные runtime места уже очищены; целевой фокус на скриптах (опционально) и будущем контроле.
2. **Lint/CI:** добавить проверку на использование “сырого” SQL в `app/` (например, `grep` в CI, исключая `alembic` и `scripts`).
3. **Скрипты:** если эти утилиты будут использоваться регулярно, рассмотреть перевод на единый CLI (например, Typer) с использованием SQLAlchemy.

## 5. Следующие шаги
- Зафиксировать ссылку на этот документ в `B-202`.
- При добавлении новых endpoints — обновлять инвентаризацию.

---

**Статус:** инвентаризация выполнена (runtime API без сырых запросов).  
**Подпись:** GPT-5 Codex — 10 Nov 2025

