# –û—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –æ—à–∏–±–æ–∫ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º

## –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2025-10-29

---

## 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### Backend –ª–æ–≥–∏ (`shot-news-backend`)
‚úÖ **–°—Ç–∞—Ç—É—Å:** –û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
- –í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ù–µ—Ç –æ—à–∏–±–æ–∫ `f405` –∏–ª–∏ `ProgrammingError`
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### Telegram Bot –ª–æ–≥–∏ (`shot-news-telegram-bot`)
‚ö†Ô∏è **–°—Ç–∞—Ç—É—Å:** –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ 409 (Conflict)
- **–û—à–∏–±–∫–∞:** `HTTP error: 409` –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
- **–ü—Ä–∏—á–∏–Ω–∞:** Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å polling
- **–†–µ—à–µ–Ω–∏–µ:** –ö–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è webhook –¥–æ–±–∞–≤–ª–µ–Ω, –Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å

---

## 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### ‚úÖ `backend/app/api/v1/endpoints/users.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–º–µ—à–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã—Ö (`$1, $2`) –∏ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö (`:param`) –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ SQL –∑–∞–ø—Ä–æ—Å–µ –≤—ã–∑—ã–≤–∞–ª–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ: —Å–º–µ—à–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
updates.append("digest_custom_schedule = :digest_custom_schedule::jsonb")

# –°—Ç–∞–ª–æ: –≤—Å–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ, –∑–∞—Ç–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ
updates.append(f"digest_custom_schedule = ${len(param_values) + 1}::jsonb")
param_values.append(json.dumps(settings.digest_custom_schedule))

# –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏:
query_with_named = re.sub(r'\$(\d+)', lambda m: f":param_{m.group(1)}", update_query)
await db.execute(text(query_with_named), bound_params)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

### ‚úÖ `backend/app/api/v1/endpoints/telegram.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** `AttributeError: 'str' object has no attribute 'value'` –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ enum –ø–æ–ª—è–º.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
digest_freq = user_prefs.digest_frequency.value

# –°—Ç–∞–ª–æ:
digest_freq = user_prefs.digest_frequency if user_prefs.digest_frequency else 'Not configured'
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Raw SQL –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `telegram_digest_mode` –≤—ã–∑—ã–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—ã —Å enum —Ç–∏–ø–∞–º–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ: raw SQL —Å CAST
# –°—Ç–∞–ª–æ: ORM –ø–æ–¥—Ö–æ–¥
user_prefs.telegram_digest_mode = new_mode
await db.commit()
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

### ‚úÖ `backend/scripts/telegram_polling.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ 409 Conflict –∏–∑-–∑–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã webhook –∏ polling.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
async def start_polling(self):
    # Delete webhook before starting polling to avoid 409 Conflict errors
    try:
        logger.info("üóëÔ∏è  Deleting webhook before starting polling...")
        success = await telegram_service.delete_webhook()
        if success:
            logger.info("‚úÖ Webhook deleted successfully")
        else:
            logger.warning("‚ö†Ô∏è  Failed to delete webhook, but continuing with polling")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è  Error deleting webhook: {e}, but continuing with polling")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)

---

## 3. –§–∞–π–ª—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å Telegram –±–æ—Ç–æ–º

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **`backend/app/api/v1/endpoints/telegram.py`**
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥: `/start`, `/settings`, `/digest`
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –∫–Ω–æ–ø–æ–∫
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ—Å—Ç—É–ø –∫ enum –∑–Ω–∞—á–µ–Ω–∏—è–º

2. **`backend/scripts/telegram_polling.py`**
   - –°–∫—Ä–∏–ø—Ç –¥–ª—è polling —Ä–µ–∂–∏–º–∞
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ `getUpdates` API
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ callback –∑–∞–ø—Ä–æ—Å–æ–≤
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ webhook –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º

3. **`backend/app/services/telegram_service.py`**
   - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–ª—è Telegram API
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ webhook (set/delete/get)
   - ‚úÖ –°—Ç–∞—Ç—É—Å: –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

4. **`backend/app/models/preferences.py`**
   - –ú–æ–¥–µ–ª—å `UserPreferences`
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ enum —Ç–∏–ø–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - ‚úÖ –°—Ç–∞—Ç—É—Å: –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

5. **`backend/app/bot/handlers.py`**
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
   - ‚úÖ –°—Ç–∞—Ç—É—Å: –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## 4. Polling vs Webhook: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Polling | Webhook |
|----------|---------|---------|
| **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** | ‚úÖ –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç HTTPS –∏ –ø—É–±–ª–∏—á–Ω—ã–π URL |
| **–ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞** | ‚ö†Ô∏è –î–æ 1 —Å–µ–∫—É–Ω–¥—ã | ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ |
| **–†–∞—Å—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤** | ‚ö†Ô∏è –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | ‚úÖ –¢–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö |
| **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ | ‚ö†Ô∏è –°–ª–æ–∂–Ω–µ–µ |
| **–î–ª—è production** | ‚ö†Ô∏è –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∞–ª—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ | ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

**–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Polling**
- –ü—Ä–æ—â–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
- –õ–µ–≥—á–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

**–î–ª—è Railway (production):**
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Webhook**
- –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è
- –õ—É—á—à–µ –¥–ª—è production –Ω–∞–≥—Ä—É–∑–∫–∏

### ‚ö†Ô∏è –í–∞–∂–Ω–æ

**–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ polling –∏ webhook –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!** –≠—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ 409 Conflict.

**–ü–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º:**
1. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ polling ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
2. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ webhook ‚Üí —É–¥–∞–ª–∏—Ç–µ webhook —á–µ—Ä–µ–∑ API –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç `setup_telegram_webhook.py delete`

---

## 5. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:
1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞ –≤ `users.py`
2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ enum –≤ `telegram.py`
3. –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ webhook –ø–µ—Ä–µ–¥ polling

### üîÑ –¢—Ä–µ–±—É–µ—Ç—Å—è:
1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä telegram-bot** –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
   ```bash
   docker restart shot-news-telegram-bot
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:
   ```bash
   docker logs shot-news-telegram-bot --tail 50 -f
   ```
   –û–∂–∏–¥–∞–µ—Ç—Å—è —É–≤–∏–¥–µ—Ç—å:
   - `üóëÔ∏è  Deleting webhook before starting polling...`
   - `‚úÖ Webhook deleted successfully`
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ 409

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∞–π–¥–∂–µ—Å—Ç–∞** —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥:
   - –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (digest_enabled, digest_frequency –∏ —Ç.–¥.)
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–∫–∏ 500

---

## 6. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### SQL –∑–∞–ø—Ä–æ—Å —Å enum —Ç–∏–ø–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –∏–º–µ–Ω–∞ enum –±–µ–∑ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π:
- `digestfrequency` (–Ω–µ `digest_frequency`)
- `digestformat` (–Ω–µ `digest_format`)
- `telegramdigestmode` (–Ω–µ `telegram_digest_mode`)

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —è–≤–Ω—ã–π CAST –≤ SQL:
```sql
CAST(:value AS text)::digestfrequency
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** SQLAlchemy —Å asyncpg –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–º–µ—à–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

**–†–µ—à–µ–Ω–∏–µ:** 
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `$1, $2, ...`
2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ `:param_1, :param_2, ...` –¥–ª—è SQLAlchemy
3. –ü–µ—Ä–µ–¥–∞—Ç—å –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—å `{"param_1": value1, "param_2": value2, ...}`

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- ‚úÖ SQL –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Enum —Ç–∏–ø—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Telegram bot –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

